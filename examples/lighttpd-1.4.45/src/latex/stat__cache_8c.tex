\hypertarget{stat__cache_8c}{\section{stat\-\_\-cache.\-c File Reference}
\label{stat__cache_8c}\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}}
}
{\ttfamily \#include \char`\"{}first.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}log.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}stat\-\_\-cache.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}fdevent.\-h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}etag.\-h\char`\"{}}\\*
{\ttfamily \#include $<$sys/types.\-h$>$}\\*
{\ttfamily \#include $<$sys/stat.\-h$>$}\\*
{\ttfamily \#include $<$stdlib.\-h$>$}\\*
{\ttfamily \#include $<$string.\-h$>$}\\*
{\ttfamily \#include $<$errno.\-h$>$}\\*
{\ttfamily \#include $<$unistd.\-h$>$}\\*
{\ttfamily \#include $<$stdio.\-h$>$}\\*
{\ttfamily \#include $<$fcntl.\-h$>$}\\*
{\ttfamily \#include $<$assert.\-h$>$}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{stat__cache_8c_ae730c85752284268b39560df693cb207}{lstat}~stat
\item 
\#define \hyperlink{stat__cache_8c_a2e375ab32c7ef4581b026be28e4cc116}{O\-\_\-\-N\-O\-C\-T\-T\-Y}~0
\item 
\#define \hyperlink{stat__cache_8c_a39d33ce33804efd4d52606d59071c6d8}{O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K}~0
\item 
\#define \hyperlink{stat__cache_8c_a82d4d551b214905742c9e045185d352a}{O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W}~0
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{structstat__cache}{stat\-\_\-cache} $\ast$ \hyperlink{stat__cache_8c_a89c129eec42d3171b23930e979683255}{stat\-\_\-cache\-\_\-init} (void)
\item 
static \hyperlink{structstat__cache__entry}{stat\-\_\-cache\-\_\-entry} $\ast$ \hyperlink{stat__cache_8c_a6204c029243e70834f71f4b36f964867}{stat\-\_\-cache\-\_\-entry\-\_\-init} (void)
\item 
static void \hyperlink{stat__cache_8c_ad5592d6678598fd6c18ebc54834e7105}{stat\-\_\-cache\-\_\-entry\-\_\-free} (void $\ast$data)
\item 
void \hyperlink{stat__cache_8c_aa59f099439354618cc158c378f59caa8}{stat\-\_\-cache\-\_\-free} (\hyperlink{structstat__cache}{stat\-\_\-cache} $\ast$sc)
\item 
static \hyperlink{base_8h_a0ddb3f43e52282b59ee55d059ed74a28}{uint32\-\_\-t} \hyperlink{stat__cache_8c_ada5a60608362c0639e658a3a8d0c0a42}{hashme} (\hyperlink{structbuffer}{buffer} $\ast$str)
\item 
\hyperlink{settings_8h_a2a8ffc3e29980db202f39ab85ab7e98e}{handler\-\_\-t} \hyperlink{stat__cache_8c_aee96b167134efc4de0e6e9f91cf45e62}{stat\-\_\-cache\-\_\-get\-\_\-entry} (\hyperlink{structserver}{server} $\ast$srv, \hyperlink{structconnection}{connection} $\ast$con, \hyperlink{structbuffer}{buffer} $\ast$name, \hyperlink{structstat__cache__entry}{stat\-\_\-cache\-\_\-entry} $\ast$$\ast$ret\-\_\-sce)
\item 
int \hyperlink{stat__cache_8c_aaa60387e5499651ac050e5caa4b3421d}{stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat} (\hyperlink{structserver}{server} $\ast$srv, \hyperlink{structconnection}{connection} $\ast$con, \hyperlink{structbuffer}{buffer} $\ast$name, struct stat $\ast$st)
\item 
static int \hyperlink{stat__cache_8c_a6c4404be136b80822237f96c96bd7b19}{stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries} (\hyperlink{structserver}{server} $\ast$srv, \hyperlink{splaytree_8h_ab42fb7db89d33ad5cdd866d99476b0e6}{splay\-\_\-tree} $\ast$t, int $\ast$keys, size\-\_\-t $\ast$ndx)
\item 
int \hyperlink{stat__cache_8c_a12eada84fe074277733303bcacd83d88}{stat\-\_\-cache\-\_\-trigger\-\_\-cleanup} (\hyperlink{structserver}{server} $\ast$srv)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{stat__cache_8c_ae730c85752284268b39560df693cb207}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!lstat@{lstat}}
\index{lstat@{lstat}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{lstat}]{\setlength{\rightskip}{0pt plus 5cm}\#define lstat~stat}}\label{stat__cache_8c_ae730c85752284268b39560df693cb207}
\hypertarget{stat__cache_8c_a2e375ab32c7ef4581b026be28e4cc116}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!O\-\_\-\-N\-O\-C\-T\-T\-Y@{O\-\_\-\-N\-O\-C\-T\-T\-Y}}
\index{O\-\_\-\-N\-O\-C\-T\-T\-Y@{O\-\_\-\-N\-O\-C\-T\-T\-Y}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{O\-\_\-\-N\-O\-C\-T\-T\-Y}]{\setlength{\rightskip}{0pt plus 5cm}\#define O\-\_\-\-N\-O\-C\-T\-T\-Y~0}}\label{stat__cache_8c_a2e375ab32c7ef4581b026be28e4cc116}


Referenced by stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat().

\hypertarget{stat__cache_8c_a82d4d551b214905742c9e045185d352a}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W@{O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W}}
\index{O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W@{O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W}]{\setlength{\rightskip}{0pt plus 5cm}\#define O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W~0}}\label{stat__cache_8c_a82d4d551b214905742c9e045185d352a}


Referenced by stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat().

\hypertarget{stat__cache_8c_a39d33ce33804efd4d52606d59071c6d8}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K@{O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K}}
\index{O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K@{O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K}]{\setlength{\rightskip}{0pt plus 5cm}\#define O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K~0}}\label{stat__cache_8c_a39d33ce33804efd4d52606d59071c6d8}


Referenced by fdevent\-\_\-fcntl\-\_\-set\-\_\-nb(), fdevent\-\_\-socket\-\_\-nb\-\_\-cloexec(), and stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat().



\subsection{Function Documentation}
\hypertarget{stat__cache_8c_ada5a60608362c0639e658a3a8d0c0a42}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!hashme@{hashme}}
\index{hashme@{hashme}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{hashme}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf uint32\-\_\-t} hashme (
\begin{DoxyParamCaption}
\item[{{\bf buffer} $\ast$}]{str}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{stat__cache_8c_ada5a60608362c0639e658a3a8d0c0a42}


References buffer\-::ptr, and uint32\-\_\-t.



Referenced by stat\-\_\-cache\-\_\-get\-\_\-entry().

\hypertarget{stat__cache_8c_ad5592d6678598fd6c18ebc54834e7105}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-entry\-\_\-free@{stat\-\_\-cache\-\_\-entry\-\_\-free}}
\index{stat\-\_\-cache\-\_\-entry\-\_\-free@{stat\-\_\-cache\-\_\-entry\-\_\-free}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-entry\-\_\-free}]{\setlength{\rightskip}{0pt plus 5cm}static void stat\-\_\-cache\-\_\-entry\-\_\-free (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{stat__cache_8c_ad5592d6678598fd6c18ebc54834e7105}


References buffer\-\_\-free(), stat\-\_\-cache\-\_\-entry\-::content\-\_\-type, stat\-\_\-cache\-\_\-entry\-::etag, and stat\-\_\-cache\-\_\-entry\-::name.



Referenced by stat\-\_\-cache\-\_\-free(), stat\-\_\-cache\-\_\-get\-\_\-entry(), and stat\-\_\-cache\-\_\-trigger\-\_\-cleanup().

\hypertarget{stat__cache_8c_a6204c029243e70834f71f4b36f964867}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-entry\-\_\-init@{stat\-\_\-cache\-\_\-entry\-\_\-init}}
\index{stat\-\_\-cache\-\_\-entry\-\_\-init@{stat\-\_\-cache\-\_\-entry\-\_\-init}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-entry\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}static {\bf stat\-\_\-cache\-\_\-entry}$\ast$ stat\-\_\-cache\-\_\-entry\-\_\-init (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{stat__cache_8c_a6204c029243e70834f71f4b36f964867}


References buffer\-\_\-init(), stat\-\_\-cache\-\_\-entry\-::content\-\_\-type, stat\-\_\-cache\-\_\-entry\-::etag, force\-\_\-assert, and stat\-\_\-cache\-\_\-entry\-::name.



Referenced by stat\-\_\-cache\-\_\-get\-\_\-entry().

\hypertarget{stat__cache_8c_aa59f099439354618cc158c378f59caa8}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-free@{stat\-\_\-cache\-\_\-free}}
\index{stat\-\_\-cache\-\_\-free@{stat\-\_\-cache\-\_\-free}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-free}]{\setlength{\rightskip}{0pt plus 5cm}void stat\-\_\-cache\-\_\-free (
\begin{DoxyParamCaption}
\item[{{\bf stat\-\_\-cache} $\ast$}]{sc}
\end{DoxyParamCaption}
)}}\label{stat__cache_8c_aa59f099439354618cc158c378f59caa8}


References buffer\-\_\-free(), tree\-\_\-node\-::data, stat\-\_\-cache\-::dir\-\_\-name, stat\-\_\-cache\-::files, force\-\_\-assert, stat\-\_\-cache\-::hash\-\_\-key, tree\-\_\-node\-::key, tree\-\_\-node\-::size, splaytree\-\_\-delete(), splaytree\-\_\-size(), and stat\-\_\-cache\-\_\-entry\-\_\-free().



Referenced by server\-\_\-free().

\hypertarget{stat__cache_8c_aee96b167134efc4de0e6e9f91cf45e62}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-get\-\_\-entry@{stat\-\_\-cache\-\_\-get\-\_\-entry}}
\index{stat\-\_\-cache\-\_\-get\-\_\-entry@{stat\-\_\-cache\-\_\-get\-\_\-entry}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-get\-\_\-entry}]{\setlength{\rightskip}{0pt plus 5cm}{\bf handler\-\_\-t} stat\-\_\-cache\-\_\-get\-\_\-entry (
\begin{DoxyParamCaption}
\item[{{\bf server} $\ast$}]{srv, }
\item[{{\bf connection} $\ast$}]{con, }
\item[{{\bf buffer} $\ast$}]{name, }
\item[{{\bf stat\-\_\-cache\-\_\-entry} $\ast$$\ast$}]{ret\-\_\-sce}
\end{DoxyParamCaption}
)}}\label{stat__cache_8c_aee96b167134efc4de0e6e9f91cf45e62}


References buffer\-\_\-append\-\_\-int(), buffer\-\_\-copy\-\_\-buffer(), buffer\-\_\-free(), buffer\-\_\-init(), buffer\-\_\-is\-\_\-empty(), buffer\-\_\-is\-\_\-equal(), buffer\-\_\-reset(), buffer\-\_\-string\-\_\-is\-\_\-empty(), buffer\-\_\-string\-\_\-length(), buffer\-\_\-string\-\_\-set\-\_\-length(), connection\-::conf, stat\-\_\-cache\-\_\-entry\-::content\-\_\-type, server\-::cur\-\_\-ts, tree\-\_\-node\-::data, array\-::data, stat\-\_\-cache\-::dir\-\_\-name, stat\-\_\-cache\-\_\-entry\-::etag, etag\-\_\-create(), connection\-::etag\-\_\-flags, stat\-\_\-cache\-::files, specific\-\_\-config\-::follow\-\_\-symlink, force\-\_\-assert, H\-A\-N\-D\-L\-E\-R\-\_\-\-E\-R\-R\-O\-R, H\-A\-N\-D\-L\-E\-R\-\_\-\-G\-O\-\_\-\-O\-N, stat\-\_\-cache\-::hash\-\_\-key, hashme(), tree\-\_\-node\-::key, log\-\_\-error\-\_\-write(), specific\-\_\-config\-::mimetypes, stat\-\_\-cache\-\_\-entry\-::name, buffer\-::ptr, splaytree\-\_\-insert(), splaytree\-\_\-size(), splaytree\-\_\-splay(), server\-::srvconf, stat\-\_\-cache\-\_\-entry\-::st, server\-::stat\-\_\-cache, server\-\_\-config\-::stat\-\_\-cache\-\_\-engine, stat\-\_\-cache\-\_\-entry\-\_\-free(), stat\-\_\-cache\-\_\-entry\-\_\-init(), stat\-\_\-cache\-\_\-entry\-::stat\-\_\-ts, specific\-\_\-config\-::use\-\_\-xattr, array\-::used, data\-\_\-string\-::value, and server\-\_\-config\-::xattr\-\_\-name.



Referenced by build\-\_\-doc\-\_\-root(), C\-O\-N\-N\-E\-C\-T\-I\-O\-N\-\_\-\-F\-U\-N\-C(), connection\-\_\-handle\-\_\-write\-\_\-prepare(), deflate\-\_\-file\-\_\-to\-\_\-file(), fcgi\-\_\-response\-\_\-parse(), http\-\_\-chunk\-\_\-append\-\_\-file\-\_\-open\-\_\-fstat(), http\-\_\-response\-\_\-prepare(), http\-\_\-response\-\_\-send\-\_\-file(), magnet\-\_\-stat(), mod\-\_\-evhost\-\_\-uri\-\_\-handler(), P\-H\-Y\-S\-I\-C\-A\-L\-P\-A\-T\-H\-\_\-\-F\-U\-N\-C(), script\-\_\-cache\-\_\-get\-\_\-script(), S\-U\-B\-R\-E\-Q\-U\-E\-S\-T\-\_\-\-F\-U\-N\-C(), U\-R\-I\-H\-A\-N\-D\-L\-E\-R\-\_\-\-F\-U\-N\-C(), and webdav\-\_\-get\-\_\-live\-\_\-property().

\hypertarget{stat__cache_8c_a89c129eec42d3171b23930e979683255}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-init@{stat\-\_\-cache\-\_\-init}}
\index{stat\-\_\-cache\-\_\-init@{stat\-\_\-cache\-\_\-init}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-init}]{\setlength{\rightskip}{0pt plus 5cm}{\bf stat\-\_\-cache}$\ast$ stat\-\_\-cache\-\_\-init (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{stat__cache_8c_a89c129eec42d3171b23930e979683255}


References buffer\-\_\-init(), stat\-\_\-cache\-::dir\-\_\-name, force\-\_\-assert, and stat\-\_\-cache\-::hash\-\_\-key.



Referenced by main().

\hypertarget{stat__cache_8c_aaa60387e5499651ac050e5caa4b3421d}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat@{stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat}}
\index{stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat@{stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat}]{\setlength{\rightskip}{0pt plus 5cm}int stat\-\_\-cache\-\_\-open\-\_\-rdonly\-\_\-fstat (
\begin{DoxyParamCaption}
\item[{{\bf server} $\ast$}]{srv, }
\item[{{\bf connection} $\ast$}]{con, }
\item[{{\bf buffer} $\ast$}]{name, }
\item[{struct stat $\ast$}]{st}
\end{DoxyParamCaption}
)}}\label{stat__cache_8c_aaa60387e5499651ac050e5caa4b3421d}


References connection\-::conf, specific\-\_\-config\-::follow\-\_\-symlink, O\-\_\-\-B\-I\-N\-A\-R\-Y, O\-\_\-\-L\-A\-R\-G\-E\-F\-I\-L\-E, O\-\_\-\-N\-O\-C\-T\-T\-Y, O\-\_\-\-N\-O\-F\-O\-L\-L\-O\-W, O\-\_\-\-N\-O\-N\-B\-L\-O\-C\-K, buffer\-::ptr, and U\-N\-U\-S\-E\-D.



Referenced by cache\-\_\-parse\-\_\-lua(), and http\-\_\-chunk\-\_\-append\-\_\-file\-\_\-open\-\_\-fstat().

\hypertarget{stat__cache_8c_a6c4404be136b80822237f96c96bd7b19}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries@{stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries}}
\index{stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries@{stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries}]{\setlength{\rightskip}{0pt plus 5cm}static int stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries (
\begin{DoxyParamCaption}
\item[{{\bf server} $\ast$}]{srv, }
\item[{{\bf splay\-\_\-tree} $\ast$}]{t, }
\item[{int $\ast$}]{keys, }
\item[{size\-\_\-t $\ast$}]{ndx}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{stat__cache_8c_a6c4404be136b80822237f96c96bd7b19}
remove stat() from cache which havn't been stat()ed for more than 10 seconds

walk though the stat-\/cache, collect the ids which are too old and remove them in a second loop 

References server\-::cur\-\_\-ts, tree\-\_\-node\-::data, tree\-\_\-node\-::key, tree\-\_\-node\-::left, tree\-\_\-node\-::right, and stat\-\_\-cache\-\_\-entry\-::stat\-\_\-ts.



Referenced by stat\-\_\-cache\-\_\-trigger\-\_\-cleanup().

\hypertarget{stat__cache_8c_a12eada84fe074277733303bcacd83d88}{\index{stat\-\_\-cache.\-c@{stat\-\_\-cache.\-c}!stat\-\_\-cache\-\_\-trigger\-\_\-cleanup@{stat\-\_\-cache\-\_\-trigger\-\_\-cleanup}}
\index{stat\-\_\-cache\-\_\-trigger\-\_\-cleanup@{stat\-\_\-cache\-\_\-trigger\-\_\-cleanup}!stat_cache.c@{stat\-\_\-cache.\-c}}
\subsubsection[{stat\-\_\-cache\-\_\-trigger\-\_\-cleanup}]{\setlength{\rightskip}{0pt plus 5cm}int stat\-\_\-cache\-\_\-trigger\-\_\-cleanup (
\begin{DoxyParamCaption}
\item[{{\bf server} $\ast$}]{srv}
\end{DoxyParamCaption}
)}}\label{stat__cache_8c_a12eada84fe074277733303bcacd83d88}


References tree\-\_\-node\-::data, stat\-\_\-cache\-::files, force\-\_\-assert, tree\-\_\-node\-::key, tree\-\_\-node\-::size, splaytree\-\_\-delete(), splaytree\-\_\-size(), splaytree\-\_\-splay(), server\-::stat\-\_\-cache, stat\-\_\-cache\-\_\-entry\-\_\-free(), and stat\-\_\-cache\-\_\-tag\-\_\-old\-\_\-entries().



Referenced by main().

