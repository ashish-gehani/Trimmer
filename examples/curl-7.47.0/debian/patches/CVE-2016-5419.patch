From 416ad90afc50d9cbcb50ba4ab28f88d260774f6d Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Fri, 1 Jul 2016 13:32:31 +0200
Subject: [PATCH] TLS: switch off SSL session id when client cert is used

CVE-2016-5419
Bug: https://curl.haxx.se/docs/adv_20160803A.html
Reported-by: Bru Rom
Contributions-by: Eric Rescorla and Ray Satiro
---
 lib/url.c       |  1 +
 lib/urldata.h   |  1 +
 lib/vtls/vtls.c | 10 ++++++++++
 3 files changed, 12 insertions(+)

Index: curl-7.47.0/lib/url.c
===================================================================
--- curl-7.47.0.orig/lib/url.c	2016-08-05 11:17:10.853127439 -0400
+++ curl-7.47.0/lib/url.c	2016-08-05 11:17:10.849127387 -0400
@@ -5781,6 +5781,7 @@
   data->set.ssl.random_file = data->set.str[STRING_SSL_RANDOM_FILE];
   data->set.ssl.egdsocket = data->set.str[STRING_SSL_EGDSOCKET];
   data->set.ssl.cipher_list = data->set.str[STRING_SSL_CIPHER_LIST];
+  data->set.ssl.clientcert = data->set.str[STRING_CERT];
 #ifdef USE_TLS_SRP
   data->set.ssl.username = data->set.str[STRING_TLSAUTH_USERNAME];
   data->set.ssl.password = data->set.str[STRING_TLSAUTH_PASSWORD];
Index: curl-7.47.0/lib/urldata.h
===================================================================
--- curl-7.47.0.orig/lib/urldata.h	2016-08-05 11:17:10.853127439 -0400
+++ curl-7.47.0/lib/urldata.h	2016-08-05 11:17:10.849127387 -0400
@@ -370,6 +370,7 @@
   char *CAfile;          /* certificate to verify peer against */
   const char *CRLfile;   /* CRL to check certificate revocation */
   const char *issuercert;/* optional issuer certificate filename */
+  char *clientcert;
   char *random_file;     /* path to file containing "random" data */
   char *egdsocket;       /* path to file containing the EGD daemon socket */
   char *cipher_list;     /* list of ciphers to use */
Index: curl-7.47.0/lib/vtls/vtls.c
===================================================================
--- curl-7.47.0.orig/lib/vtls/vtls.c	2016-08-05 11:17:10.853127439 -0400
+++ curl-7.47.0/lib/vtls/vtls.c	2016-08-05 11:17:10.849127387 -0400
@@ -156,6 +156,15 @@
   else
     dest->random_file = NULL;
 
+  if(source->clientcert) {
+    dest->clientcert = strdup(source->clientcert);
+    if(!dest->clientcert)
+      return FALSE;
+    dest->sessionid = FALSE;
+  }
+  else
+    dest->clientcert = NULL;
+
   return TRUE;
 }
 
@@ -166,6 +175,7 @@
   Curl_safefree(sslc->cipher_list);
   Curl_safefree(sslc->egdsocket);
   Curl_safefree(sslc->random_file);
+  Curl_safefree(sslc->clientcert);
 }
 
 
