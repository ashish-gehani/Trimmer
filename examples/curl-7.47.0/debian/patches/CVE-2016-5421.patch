From ccb7d79b62c8b15a6be446f9c9fd3767c01eb5b6 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Sun, 31 Jul 2016 01:09:04 +0200
Subject: [PATCH] curl_multi_cleanup: clear connection pointer for easy handles
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

CVE-2016-5421
Bug: https://curl.haxx.se/docs/adv_20160803C.html
Reported-by: Marcelo Echeverria and Fernando MuÃ±oz
---
 lib/multi.c | 2 ++
 1 file changed, 2 insertions(+)

Index: curl-7.47.0/lib/multi.c
===================================================================
--- curl-7.47.0.orig/lib/multi.c	2016-08-05 11:17:23.305289332 -0400
+++ curl-7.47.0/lib/multi.c	2016-08-05 11:17:23.301289281 -0400
@@ -1869,6 +1869,8 @@
     conn->data = multi->closure_handle;
 
     sigpipe_ignore(conn->data, &pipe_st);
+    conn->data->easy_conn = NULL; /* clear the easy handle's connection
+                                     pointer */
     /* This will remove the connection from the cache */
     (void)Curl_disconnect(conn, FALSE);
     sigpipe_restore(&pipe_st);
